<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Task Management Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
        .kanban-column {
            min-height: 400px;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            background-color: #f8f9fa;
        }
        .task-card {
            margin-bottom: 10px;
            cursor: grab;
        }
    </style>
</head>
<body>
<div class="container mt-4">
    <h1>Task Management Dashboard</h1>
    <div class="row">
        <div class="col-md-4">
            <h3>To Do</h3>
            <div id="todo" class="kanban-column" data-status="todo"></div>
        </div>
        <div class="col-md-4">
            <h3>In Progress</h3>
            <div id="in_progress" class="kanban-column" data-status="in_progress"></div>
        </div>
        <div class="col-md-4">
            <h3>Done</h3>
            <div id="done" class="kanban-column" data-status="done"></div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const ws = new WebSocket(`${protocol}//${window.location.host}/ws/tasks/`);

    ws.onopen = function(event) {
        console.log('WebSocket connected');
    };

    ws.onmessage = function(event) {
        const data = JSON.parse(event.data);
        if (data.action === 'task_update') {
            updateTask(data.task);
        }
    };

    ws.onclose = function(event) {
        console.log('WebSocket disconnected');
    };

    function updateTask(task) {
        // Remove existing task card
        const existingCard = document.querySelector(`[data-task-id="${task.id}"]`);
        if (existingCard) {
            existingCard.remove();
        }
        // Add updated task card
        addTaskCard(task);
    }

    function addTaskCard(task) {
        const column = document.getElementById(task.status);
        const card = document.createElement('div');
        card.className = 'card task-card';
        card.setAttribute('data-task-id', task.id);
        card.innerHTML = `
            <div class="card-body">
                <h5 class="card-title">${task.title}</h5>
                <p class="card-text">${task.description}</p>
                <small class="text-muted">Assigned to: ${task.assigned_to_username || 'Unassigned'}</small>
            </div>
        `;
        column.appendChild(card);
    }

    // Load initial tasks
    fetch('/api/tasks/')
        .then(response => response.json())
        .then(data => {
            data.forEach(task => addTaskCard(task));
        });

    // Make columns sortable
    ['todo', 'in_progress', 'done'].forEach(status => {
        new Sortable(document.getElementById(status), {
            group: 'tasks',
            animation: 150,
            onEnd: function(evt) {
                const taskId = evt.item.getAttribute('data-task-id');
                const newStatus = evt.to.getAttribute('data-status');
                // Send update via WebSocket
                ws.send(JSON.stringify({
                    action: 'update_task',
                    task: { id: taskId, status: newStatus }
                }));
            }
        });
    });
</script>
</body>
</html>
